<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     Oct 5, 2012 3:53:59 PM                                                        

     Windows Protege OWL Service    
     Windows Service for the Protege OWL Server
                   
     tredmond                                                                
     ====================================================================== -->
<project name="Windows Protege OWL Service" default="deploy">
    <description>
            Windows Service for the Protege OWL Server
    </description>
	<property file="windows.properties"/>
	<property name="server.prefix" location="${install.prefix}/server"/>
	<property name="dev.tools"     location="${server.prefix}/bin/dev-tools.jar"/>
	<property name="build"         location="build"/>
	<property name="classes"       location="${build}/classes"/>
	<property name="jar"           location="${build}/winsvc.jar"/>
	<property name="service.src"   location="./apache-commons-daemon/amd64/prunsrv.exe"/>
	<property name="service"       location="${server.prefix}/bin/OWLDocService.exe"/>
	<property name="manager.src"   location="./apache-commons-daemon/prunmgr.exe"/>
	<property name="manager"       location="${server.prefix}/bin/OWLServiceManager.exe"/>
	
    <taskdef name="check.dependencies"
	         classname="org.protege.ant.ProtegeDependencies">
	    <classpath>
		  <pathelement location="${dev.tools}"/>
	    </classpath>
    </taskdef>

	<target name="init">
		<mkdir dir="${classes}"/>
	    <check.dependencies>
		  <property name="osgi.lib"     location="${server.prefix}/lib/felix.jar"/>
		  <property name="launcher.lib" location="${server.prefix}/lib/ProtegeLauncher.jar"/>
	    </check.dependencies>
	    <path id = "project.classpath">    
	      <pathelement location="${osgi.lib}"/>
	      <pathelement location="${launcher.lib}"/>
	    </path>
	</target>

	<target name="compile" depends="init">
		<javac srcdir="./src" destdir="${classes}"
			   debug="true" includeantruntime="false">
			<classpath refid="project.classpath"/>
		</javac>
	</target>
	
	<target name="jar" depends="compile">
		<jar destfile="${jar}" basedir="${classes}"/>
	</target>

    <target name="install" depends="jar">
        <copy file="${jar}"          todir="${server.prefix}/bin"/>
    	<copy file="${service.src}"  tofile="${service}"/>
    	<copy file="${manager.src}"  tofile="${manager}"/>
    </target>
	
    <target name="deploy" depends="install" description="Windows Service for the Protege OWL Server">

        <java classname="org.protege.owl.server.command.SetMetaprojectDataDir"
    	  fork="true"
        	  failonerror="true">
            <classpath>
              <pathelement path="${classes}"/>
              <path refid="project.classpath"/>
            </classpath>
        	<arg value="${install.prefix}/server/metaproject.owl"/>
        	<arg value="${install.prefix}/data"/>
      	</java>
        <java classname="org.protege.owl.server.command.SetMetaProjectPort"
    	  fork="true"
        	  failonerror="true">
            <classpath>
              <pathelement path="${classes}"/>
              <path refid="project.classpath"/>
            </classpath>
        	<arg value="${install.prefix}/server/metaproject.owl"/>
        	<arg value="${install.port}"/>
      	</java>
        <exec dir="${server.prefix}" 
        	  executable="${service.src}" 
        	  failifexecutionfails="true" failonerror="true">
            <arg value="//IS//OWLServer"/>
        	<arg value="--Install=${service}"/>
        	<arg value="--Jvm=auto"/>
        	<arg value="--Description=Protege-OWL-Document-Service"/>
        	<arg value="--DisplayName=OWLServer"/>
        	<arg value="--LogPath=${server.prefix}\Logs"/>
        	<arg value="--StdOutput=auto"/>
        	<arg value="--StdError=auto"/>
        	<arg value="--Startup=auto"/>
            <arg value="--Classpath=bin/winsvc.jar;lib/felix.jar;lib/ProtegeLauncher.jar"/>
        	<arg value="--JvmMx=${memory.mb}"/>
        	<arg value="++JvmOptions=-DentityExpansionLimit=100000000"/>
        	<arg value="++JvmOptions=-Dfile.encoding=UTF-8"/>
        	<arg value="++JvmOptions=-Dorg.protege.owl.server.configuration=metaproject.owl"/>
        	<arg value="++JvmOptions=-Djava.util.logging.config.file=logging.properties"/>
            <arg value="--StartPath=C://Program Files/Protege Server/server"/>
        	<arg value="--StartMode=jvm"/>
        	<arg value="--StartClass=org.protege.owl.server.windows.service.WindowsOWLServer"/>
        	<arg value="--StartParams=start"/>
            <arg value="--StopPath=C://Program Files/Protege Server/server"/>
        	<arg value="--StopMode=jvm"/>
        	<arg value="--StopClass=org.protege.owl.server.windows.service.WindowsOWLServer"/>
        	<arg value="--StopParams=stop"/>
    	</exec>
    </target>

    <target name="test" description="Windows Service for the Protege OWL Server">
        <exec dir="${server.prefix}" 
        	  executable="${service.src}">
            <arg value="//TS//OWLServer"/>
    	</exec>
    </target>


    <target name="undeploy" description="Windows Service for the Protege OWL Server">
        <exec dir="${server.prefix}" 
        	  executable="${service.src}">
            <arg value="//DS//OWLServer"/>
    	</exec>
    </target>


	<target name="clean">
		<delete dir="${build}"/>
	</target>


</project>
