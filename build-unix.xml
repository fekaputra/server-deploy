<?xml version = "1.0" encoding = "utf-8"?>
<project name = "OWL Ontology Server Deployment" default = "install" basedir = ".">
  <property file="unix.properties"/>
  <property name="server.prefix"  location="/usr/local/protege.server"/>
  <property name="data.prefix"    location="/var/protege.server"/>
  <property name="log.prefix"     location="/var/log/protege"/>
  <property name="install.port"   value="4875"/>

  <property name="dev.tools"      location="${server.prefix}/bin/dev-tools.jar"/>

  <taskdef name="check.dependencies"
  	       classname="org.protege.ant.ProtegeDependencies">
    <classpath>
	  <pathelement location="${dev.tools}"/>
    </classpath>
  </taskdef>

  <target name="init">
    <check.dependencies>
      <property name="owl.lib"    location="${server.prefix}/bundles/org.semanticweb.owl.owlapi.jar"/>
      <property name="server.lib" location="${server.prefix}/bundles/org.protege.owl.server.jar"/>
    </check.dependencies>
    <path id = "project.classpath">    
      <pathelement location="${owl.lib}"/>
      <pathelement location="${server.lib}"/>
    </path>
  </target>

  <target name = "install" depends="init">
    <copy file="./unix/logging-unix.properties" todir="${server.prefix}"/>
    <replace file="${server.prefix}/logging-unix.properties" token="@log.prefix@" value="${log.prefix}"/>

    <copy file="./unix/protege.defaults" tofile="/etc/default/protege"/>
    <replace file="/etc/default/protege" token="@data.prefix@"   value="${data.prefix}"/>
    <replace file="/etc/default/protege" token="@hostname@"      value="${hostname}"/>
    <replace file="/etc/default/protege" token="@java.cmd@"      value="${java.cmd}"/>
    <replace file="/etc/default/protege" token="@log.prefix@"    value="${log.prefix}"/>
    <replace file="/etc/default/protege" token="@memory@"        value="${memory}"/>
    <replace file="/etc/default/protege" token="@sandbox.user@"  value="${sandbox.user}"/>
    <replace file="/etc/default/protege" token="@server.prefix@" value="${server.prefix}"/>

    <copy file="./unix/protege" todir="/etc/init.d"/>
    <chmod file="/etc/init.d/protege" perm="ugo+x"/>

    <java classname="org.protege.owl.server.command.SetMetaprojectDataDir"
          fork="true" failonerror="true">
      <classpath>
        <pathelement path="${classes}" />
        <path refid="project.classpath" />
      </classpath>
      <arg value="${server.prefix}/metaproject.owl" />
      <arg value="${data.prefix}/ontologies" />
    </java>
    <java classname="org.protege.owl.server.command.SetMetaProjectPort"
          fork="true" failonerror="true">
      <classpath>
        <pathelement path="${classes}" />
        <path refid="project.classpath" />
      </classpath>
      <arg value="${server.prefix}/metaproject.owl" />
      <arg value="${install.port}" />
    </java>
    <exec executable="update-rc.d">
    	<arg value="protege"/>
    	<arg value="defaults"/>
    </exec>
    <exec executable="/etc/init.d/protege">
    	<arg value="start"/>
    </exec>
  </target>
</project>
